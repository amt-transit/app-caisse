<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¦ Gestionnaire de Livraisons - AMT TRANS'IT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“¦ Gestionnaire de Livraisons - AMT TRANS'IT</h1>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="totalDeliveries">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pendingDeliveries">0</div>
                    <div class="stat-label">En Attente</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completedDeliveries">0</div>
                    <div class="stat-label">LivrÃ©es</div>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('EN_COURS')" id="tabEnCours">ğŸ“¦ Conteneurs en cours</button>
            <button class="tab-btn" onclick="switchTab('A_VENIR')" id="tabAVenir">ğŸš¢ Conteneurs Ã  venir</button>
            <button class="tab-btn" onclick="switchTab('PARIS')" id="tabParis">ğŸ‡«ğŸ‡· Paris (Tout)</button>
            <button class="tab-btn" onclick="switchTab('PROGRAMME')" id="tabProgramme">ğŸ“… Programmes</button>
        </div>

        <div class="toolbar">
            <!-- BARRE D'OUTILS : EN COURS -->
            <div id="toolbar-EN_COURS" class="tab-toolbar" style="display: flex;">
                <div style="display: flex; align-items: center; gap: 10px; background: #e3f2fd; padding: 5px 10px; border-radius: 6px; border: 1px solid #bbdefb;">
                    <span style="font-weight: bold; color: #1565c0;">ğŸ“¦ Conteneur Actif :</span>
                    <input type="text" id="activeContainerInput" placeholder="NÂ° Conteneur" style="padding: 5px; width: 150px;">
                    <button class="btn btn-small btn-success" onclick="setActiveContainer()">DÃ©finir</button>
                </div>

                <label class="btn">
                    ğŸ“Š Importer Excel
                    <input type="file" accept=".xlsx,.xls" onchange="importExcel(event)">
                </label>
                
                <button class="btn" onclick="openProgramModal()">ğŸ“… Programmer</button>
                <button class="btn" onclick="openAssignContainerModal()">ğŸ“¦ Attribuer Conteneur</button>
                <button class="btn" onclick="openBulkStatusModal()">ğŸ”„ Statut</button>
                <button class="btn btn-danger" onclick="deleteSelectedDeliveries()">ğŸ—‘ï¸ Supprimer</button>
                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Exporter</button>
                <button class="btn" onclick="showAddModal()">â• Ajouter</button>
                <button class="btn btn-warning" onclick="archiveCompletedDeliveries()">ğŸ“¦ Archiver LivrÃ©s</button>
                <button class="btn" onclick="openArchivesModal()">ğŸ—„ï¸ Archives</button>
            </div>

            <!-- BARRE D'OUTILS : A VENIR -->
            <div id="toolbar-A_VENIR" class="tab-toolbar" style="display: none;">
                <label class="btn">
                    ğŸ“Š Importer Excel
                    <input type="file" accept=".xlsx,.xls" onchange="importExcel(event)">
                </label>
                <button class="btn" onclick="openAssignContainerModal()">ğŸ“¦ Attribuer Conteneur</button>
                <button class="btn btn-danger" onclick="deleteSelectedDeliveries()">ğŸ—‘ï¸ Supprimer</button>
                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Exporter</button>
                <button class="btn" onclick="showAddModal()">â• Ajouter</button>
            </div>

            <!-- BARRE D'OUTILS : PARIS -->
            <div id="toolbar-PARIS" class="tab-toolbar" style="display: none;">
                <label class="btn">
                    ğŸ“Š Importer Excel
                    <input type="file" accept=".xlsx,.xls" onchange="importExcel(event)">
                </label>
                <button class="btn btn-danger" onclick="deleteSelectedDeliveries()">ğŸ—‘ï¸ Supprimer</button>
                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Exporter</button>
                <button class="btn" onclick="showAddModal()">â• Ajouter</button>
            </div>

            <!-- BARRE D'OUTILS : PROGRAMME -->
            <div id="toolbar-PROGRAMME" class="tab-toolbar" style="display: none;">
                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Exporter</button>
                <button class="btn" onclick="openArchivesModal()">ğŸ—„ï¸ Archives</button>
            </div>
            
            <div class="dropdown-filter" id="communeFilter">
                <button class="search-filter dropdown-toggle" onclick="toggleCommuneDropdown()" id="communeFilterBtn">ğŸ“ Toutes les communes</button>
                <div class="dropdown-menu" id="communeDropdownList">
                    <label><input type="checkbox" value="COCODY" onchange="filterDeliveries()"> COCODY</label>
                    <label><input type="checkbox" value="YOPOUGON" onchange="filterDeliveries()"> YOPOUGON</label>
                    <label><input type="checkbox" value="ABOBO" onchange="filterDeliveries()"> ABOBO</label>
                    <label><input type="checkbox" value="ADJAME" onchange="filterDeliveries()"> ADJAMÃ‰</label>
                    <label><input type="checkbox" value="KOUMASSI" onchange="filterDeliveries()"> KOUMASSI</label>
                    <label><input type="checkbox" value="MARCORY" onchange="filterDeliveries()"> MARCORY</label>
                    <label><input type="checkbox" value="TREICHVILLE" onchange="filterDeliveries()"> TREICHVILLE</label>
                    <label><input type="checkbox" value="ATTECOUBE" onchange="filterDeliveries()"> ATTÃ‰COUBÃ‰</label>
                    <label><input type="checkbox" value="PORT-BOUET" onchange="filterDeliveries()"> PORT-BOUÃ‹T</label>
                    <label><input type="checkbox" value="BINGERVILLE" onchange="filterDeliveries()"> BINGERVILLE</label>
                    <label><input type="checkbox" value="SONGON" onchange="filterDeliveries()"> SONGON</label>
                    <label><input type="checkbox" value="ANYAMA" onchange="filterDeliveries()"> ANYAMA</label>
                    <label><input type="checkbox" value="PLATEAU" onchange="filterDeliveries()"> PLATEAU</label>
                    <label><input type="checkbox" value="AUTRE" onchange="filterDeliveries()"> AUTRE</label>
                </div>
            </div>
            
            <div class="dropdown-filter" id="locationFilter">
                <button class="search-filter dropdown-toggle" onclick="toggleLocationDropdown()" id="locationFilterBtn">ğŸ“ Tous les lieux</button>
                <div class="dropdown-menu" id="locationDropdownList">
                    <!-- Rempli par JS -->
                </div>
            </div>
            
            <div class="dropdown-filter" id="statusFilter">
                <button class="search-filter dropdown-toggle" onclick="toggleStatusDropdown()" id="statusFilterBtn">ğŸ“Š Tous les statuts</button>
                <div class="dropdown-menu" id="statusDropdownList">
                    <label><input type="checkbox" value="EN_ATTENTE" onchange="filterDeliveries()"> â³ En Attente</label>
                    <label><input type="checkbox" value="EN_COURS" onchange="filterDeliveries()"> ğŸšš En Cours</label>
                    <label><input type="checkbox" value="LIVRE" onchange="filterDeliveries()"> âœ… LivrÃ©</label>
                </div>
            </div>
            
            <input type="text" class="search-filter" id="searchBox" placeholder="ğŸ” Rechercher..." oninput="debouncedFilterDeliveries()">
        </div>

        <div class="table-container">
            <h2 id="currentContainerTitle" style="margin-bottom: 15px; color: #2c3e50; font-size: 1.2em;">Conteneur en cours : Aucun</h2>
            <table id="deliveriesTable">
                <thead>
                    <tr>
                        <th class="col-checkbox"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th class="sortable" onclick="sortTable('conteneur')" style="width: 120px;">CONTENEUR â†•</th>
                        <th class="sortable" onclick="sortTable('ref')" style="width: 100px;">REF â†•</th>
                        <th class="sortable" onclick="sortTable('montant')" style="width: 100px;">MONTANT â†•</th>
                        <th class="sortable" onclick="sortTable('expediteur')" style="width: 150px;">EXPEDITEUR â†•</th>
                        <th class="sortable" onclick="sortTable('lieuLivraison')" style="width: 250px;">LIEU DE LIVRAISON â†•</th>
                        <th class="sortable" onclick="sortTable('destinataire')" style="width: 180px;">DESTINATAIRE â†•</th>
                        <th style="width: 250px;">DESCRIPTION</th>
                        <th style="width: 150px;">INFO</th>
                        <th class="sortable" onclick="sortTable('livreur')" style="width: 150px;">LIVREUR (DATE) â†•</th>
                        <th style="width: 80px;">STATUT</th>
                        <th style="width: 150px;">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="deliveriesBody">
                    <tr>
                        <td colspan="12" class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <h3>Aucune livraison</h3>
                            <p>Importez un PDF/Excel ou ajoutez manuellement</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Ajout -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">â• Nouvelle Livraison</h2>
            <form id="deliveryForm">
                <div class="form-grid">
                    <div class="form-group full-width" style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                        <label>Statut du Conteneur</label>
                        <select id="newContainerStatus">
                            <option value="PARIS">ğŸ‡«ğŸ‡· Stock Paris (Non chargÃ©)</option>
                            <option value="EN_COURS">ğŸ“¦ En cours (ArrivÃ©)</option>
                            <option value="A_VENIR">ğŸš¢ Ã€ venir (En transit)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>NÂ° Conteneur</label>
                        <input type="text" id="conteneur" placeholder="Ex: CONT-123456">
                    </div>

                    <div class="form-group">
                        <label>RÃ©fÃ©rence *</label>
                        <input type="text" id="ref" required placeholder="Ex: BA-001-D44">
                    </div>
                    
                    <div class="form-group">
                        <label>Montant Restant</label>
                        <input type="text" id="montant" placeholder="Ex: 50000 CFA">
                    </div>
                    
                    <div class="form-group">
                        <label>ExpÃ©diteur *</label>
                        <input type="text" id="expediteur" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Commune *</label>
                        <select id="commune" required>
                            <option value="">-- SÃ©lectionnez --</option>
                            <option value="COCODY">COCODY</option>
                            <option value="YOPOUGON">YOPOUGON</option>
                            <option value="ABOBO">ABOBO</option>
                            <option value="ADJAME">ADJAMÃ‰</option>
                            <option value="KOUMASSI">KOUMASSI</option>
                            <option value="MARCORY">MARCORY</option>
                            <option value="TREICHVILLE">TREICHVILLE</option>
                            <option value="ATTECOUBE">ATTÃ‰COUBÃ‰</option>
                            <option value="PORT-BOUET">PORT-BOUÃ‹T</option>
                            <option value="BINGERVILLE">BINGERVILLE</option>
                            <option value="SONGON">SONGON</option>
                            <option value="ANYAMA">ANYAMA</option>
                            <option value="PLATEAU">PLATEAU</option>
                            <option value="AUTRE">AUTRE</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Lieu de Livraison *</label>
                        <input type="text" id="lieuLivraison" required list="sharedLocationsList" autocomplete="off">
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Destinataire & TÃ©lÃ©phone *</label>
                        <input type="text" id="destinataire" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Description</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">âœ… Ajouter</button>
                    <button type="button" class="btn btn-danger" onclick="closeAddModal()">âŒ Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal AperÃ§u Import -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">ğŸ“‹ AperÃ§u de l'import</h2>
            
            <div class="form-grid" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <div class="form-group full-width">
                    <label>Destination de l'import</label>
                    <select id="importContainerStatus" style="width: 100%;">
                        <option value="PARIS">ğŸ‡«ğŸ‡· Ajouter au Stock PARIS</option>
                        <option value="EN_COURS">ğŸ“¦ Ajouter aux Conteneurs EN COURS</option>
                        <option value="A_VENIR">ğŸš¢ Ajouter aux Conteneurs Ã€ VENIR</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>NÂ° Conteneur (pour ce lot)</label>
                    <input type="text" id="importConteneur" placeholder="Appliquer Ã  tout l'import">
                </div>
                <div class="form-group">
                    <label>NÂ° BL (pour ce lot)</label>
                    <input type="text" id="importBl" placeholder="Appliquer Ã  tout l'import">
                </div>
            </div>

            <p id="previewCount"></p>
            <div class="preview-table">
                <table>
                    <thead>
                        <tr>
                            <th>REF</th>
                            <th>EXPEDITEUR</th>
                            <th>COMMUNE</th>
                            <th>LIEU</th>
                            <th>INFO</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmImport()">âœ… Confirmer Import</button>
                <button class="btn btn-danger" onclick="closePreviewModal()">âŒ Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Programmation -->
    <div id="programModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">ğŸ“… CrÃ©er un Programme de Livraison</h2>
            <p style="margin-bottom: 20px;">Assigner les <strong id="selectedCount">0</strong> colis sÃ©lectionnÃ©s Ã  :</p>
            
            <div class="form-grid">
                <div class="form-group full-width" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <label>â• Ajouter Ã  un programme existant</label>
                    <select id="existingProgramSelect" onchange="fillProgramFields()">
                        <option value="">-- Nouveau Programme --</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Livreur / Chauffeur</label>
                    <input type="text" id="progLivreur" placeholder="Nom du livreur">
                </div>
                <div class="form-group full-width">
                    <label>Date de Livraison PrÃ©vue</label>
                    <input type="date" id="progDate">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmProgram()">ğŸ’¾ Enregistrer le Programme</button>
                <button class="btn btn-danger" onclick="closeProgramModal()">âŒ Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Attribution Conteneur -->
    <div id="assignContainerModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">ğŸ“¦ Attribuer un Conteneur</h2>
            <p style="margin-bottom: 20px;">Attribuer le conteneur suivant aux <strong id="assignSelectedCount">0</strong> colis sÃ©lectionnÃ©s :</p>
            
            <div class="form-group full-width">
                <label>Nouvelle Position (Optionnel)</label>
                <select id="assignContainerStatus">
                    <option value="">-- Ne pas changer la position --</option>
                    <option value="PARIS">ğŸ‡«ğŸ‡· Stock Paris</option>
                    <option value="A_VENIR">ğŸš¢ En Transit (Ã€ Venir)</option>
                    <option value="EN_COURS">ğŸ“¦ ArrivÃ© (En Cours)</option>
                </select>
            </div>
            
            <div class="form-group full-width">
                <label>NÂ° Conteneur</label>
                <input type="text" id="assignConteneurInput" placeholder="Ex: CONT-123456">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmAssignContainer()">ğŸ’¾ Enregistrer</button>
                <button class="btn btn-danger" onclick="closeAssignContainerModal()">âŒ Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Changement Statut GroupÃ© -->
    <div id="bulkStatusModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">ğŸ”„ Changer le statut</h2>
            <p>Pour <strong id="bulkStatusCount">0</strong> colis sÃ©lectionnÃ©s :</p>
            <div class="form-group full-width">
                <label>Nouveau Statut</label>
                <select id="bulkStatusSelect">
                    <option value="EN_ATTENTE">â³ En Attente</option>
                    <option value="EN_COURS">ğŸšš En Cours</option>
                    <option value="LIVRE">âœ… LivrÃ©</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmBulkStatusChange()">ğŸ’¾ Enregistrer</button>
                <button class="btn btn-danger" onclick="closeBulkStatusModal()">âŒ Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal DÃ©tails Programme -->
    <div id="programDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 95%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="modal-header" style="margin-bottom: 0;">ğŸ“‹ Feuille de route</h2>
                <div style="display: flex; gap: 10px;">
                    <button id="btnOpenMap" class="btn btn-warning btn-small">ğŸ—ºï¸ Voir l'itinÃ©raire</button>
                    <button id="btnExportPdf" class="btn btn-success btn-small">ğŸ“„ Exporter PDF</button>
                    <button class="btn btn-danger btn-small" onclick="closeProgramDetailsModal()">Fermer</button>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>Livreur :</strong> <span id="detailLivreur"></span></p>
                <p><strong>Date :</strong> <span id="detailDate"></span></p>
            </div>

            <div class="preview-table">
                <table id="programDetailsTable">
                    <!-- Rempli par JS -->
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Archives -->
    <div id="archivesModal" class="modal">
        <div class="modal-content" style="max-width: 95%; height: 90vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="modal-header" style="margin-bottom: 0;">ğŸ—„ï¸ Archives des Livraisons</h2>
                <button class="btn btn-danger btn-small" onclick="closeArchivesModal()">Fermer</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="archiveSearch" class="search-filter" placeholder="ğŸ” Rechercher dans les archives..." oninput="searchArchives()">
            </div>

            <div class="preview-table" style="max-height: calc(90vh - 150px);">
                <table id="archivesTable">
                    <thead>
                        <tr>
                            <th>DATE ARCHIVAGE</th>
                            <th>REF</th>
                            <th>CONTENEUR</th>
                            <th>DESTINATAIRE</th>
                            <th>LIVREUR</th>
                            <th>DATE LIVRAISON</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="archivesBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Liste partagÃ©e pour l'auto-complÃ©tion des lieux -->
    <datalist id="sharedLocationsList"></datalist>

    <script src="../livraison.js"></script>
</body>
</html>