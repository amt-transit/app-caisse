<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Gestionnaire de Livraisons - AMT TRANS'IT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üì¶ Gestionnaire de Livraisons - AMT TRANS'IT</h1>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="totalDeliveries">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pendingDeliveries">0</div>
                    <div class="stat-label">En Attente</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completedDeliveries">0</div>
                    <div class="stat-label">Livr√©es</div>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('EN_COURS')" id="tabEnCours">üì¶ Conteneurs en cours</button>
            <button class="tab-btn" onclick="switchTab('A_VENIR')" id="tabAVenir">üö¢ Conteneurs √† venir</button>
            <button class="tab-btn" onclick="switchTab('PARIS')" id="tabParis">üá´üá∑ Paris (Tout)</button>
            <button class="tab-btn" onclick="switchTab('PROGRAMME')" id="tabProgramme">üìÖ Programmes</button>
        </div>

        <div class="toolbar">
            <!-- BARRE D'OUTILS : EN COURS -->
            <div id="toolbar-EN_COURS" class="tab-toolbar" style="display: flex;">
                <div style="display: flex; align-items: center; gap: 10px; background: #e3f2fd; padding: 5px 10px; border-radius: 6px; border: 1px solid #bbdefb;">
                    <span style="font-weight: bold; color: #1565c0;">üì¶ Conteneur Actif :</span>
                    <input type="text" id="activeContainerInput" placeholder="N¬∞ Conteneur" style="padding: 5px; width: 150px;">
                    <button class="btn btn-small btn-success" onclick="setActiveContainer()">D√©finir</button>
                </div>

                <label class="btn">
                    üìä Importer Excel
                    <input type="file" accept=".xlsx,.xls" onchange="importExcel(event)">
                </label>
                
                <button class="btn" onclick="openProgramModal()">üìÖ Programmer</button>
                <button class="btn" onclick="openAssignContainerModal()">üì¶ Attribuer Conteneur</button>
                <button class="btn btn-success" onclick="exportToExcel()">üì• Exporter</button>
                <button class="btn" onclick="showAddModal()">‚ûï Ajouter</button>
                <button class="btn btn-warning" onclick="archiveCompletedDeliveries()">üì¶ Archiver Livr√©s</button>
                <button class="btn" onclick="openArchivesModal()">üóÑÔ∏è Archives</button>
            </div>

            <!-- BARRE D'OUTILS : A VENIR -->
            <div id="toolbar-A_VENIR" class="tab-toolbar" style="display: none;">
                <label class="btn">
                    üìä Importer Excel
                    <input type="file" accept=".xlsx,.xls" onchange="importExcel(event)">
                </label>
                <button class="btn" onclick="openAssignContainerModal()">üì¶ Attribuer Conteneur</button>
                <button class="btn btn-success" onclick="exportToExcel()">üì• Exporter</button>
                <button class="btn" onclick="showAddModal()">‚ûï Ajouter</button>
            </div>

            <!-- BARRE D'OUTILS : PARIS -->
            <div id="toolbar-PARIS" class="tab-toolbar" style="display: none;">
                <label class="btn">
                    üìä Importer Excel
                    <input type="file" accept=".xlsx,.xls" onchange="importExcel(event)">
                </label>
                <button class="btn btn-success" onclick="exportToExcel()">üì• Exporter</button>
                <button class="btn" onclick="showAddModal()">‚ûï Ajouter</button>
            </div>

            <!-- BARRE D'OUTILS : PROGRAMME -->
            <div id="toolbar-PROGRAMME" class="tab-toolbar" style="display: none;">
                <button class="btn btn-success" onclick="exportToExcel()">üì• Exporter</button>
                <button class="btn" onclick="openArchivesModal()">üóÑÔ∏è Archives</button>
            </div>
            
            <div class="dropdown-filter" id="communeFilter">
                <button class="search-filter dropdown-toggle" onclick="toggleCommuneDropdown()" id="communeFilterBtn">üìç Toutes les communes</button>
                <div class="dropdown-menu" id="communeDropdownList">
                    <label><input type="checkbox" value="COCODY" onchange="filterDeliveries()"> COCODY</label>
                    <label><input type="checkbox" value="YOPOUGON" onchange="filterDeliveries()"> YOPOUGON</label>
                    <label><input type="checkbox" value="ABOBO" onchange="filterDeliveries()"> ABOBO</label>
                    <label><input type="checkbox" value="ADJAME" onchange="filterDeliveries()"> ADJAM√â</label>
                    <label><input type="checkbox" value="KOUMASSI" onchange="filterDeliveries()"> KOUMASSI</label>
                    <label><input type="checkbox" value="MARCORY" onchange="filterDeliveries()"> MARCORY</label>
                    <label><input type="checkbox" value="TREICHVILLE" onchange="filterDeliveries()"> TREICHVILLE</label>
                    <label><input type="checkbox" value="ATTECOUBE" onchange="filterDeliveries()"> ATT√âCOUB√â</label>
                    <label><input type="checkbox" value="PORT-BOUET" onchange="filterDeliveries()"> PORT-BOU√ãT</label>
                    <label><input type="checkbox" value="BINGERVILLE" onchange="filterDeliveries()"> BINGERVILLE</label>
                    <label><input type="checkbox" value="SONGON" onchange="filterDeliveries()"> SONGON</label>
                    <label><input type="checkbox" value="ANYAMA" onchange="filterDeliveries()"> ANYAMA</label>
                    <label><input type="checkbox" value="PLATEAU" onchange="filterDeliveries()"> PLATEAU</label>
                    <label><input type="checkbox" value="AUTRE" onchange="filterDeliveries()"> AUTRE</label>
                </div>
            </div>
            
            <div class="dropdown-filter" id="locationFilter">
                <button class="search-filter dropdown-toggle" onclick="toggleLocationDropdown()" id="locationFilterBtn">üìç Tous les lieux</button>
                <div class="dropdown-menu" id="locationDropdownList">
                    <!-- Rempli par JS -->
                </div>
            </div>
            
            <div class="dropdown-filter" id="statusFilter">
                <button class="search-filter dropdown-toggle" onclick="toggleStatusDropdown()" id="statusFilterBtn">üìä Tous les statuts</button>
                <div class="dropdown-menu" id="statusDropdownList">
                    <label><input type="checkbox" value="EN_ATTENTE" onchange="filterDeliveries()"> ‚è≥ En Attente</label>
                    <label><input type="checkbox" value="EN_COURS" onchange="filterDeliveries()"> üöö En Cours</label>
                    <label><input type="checkbox" value="LIVRE" onchange="filterDeliveries()"> ‚úÖ Livr√©</label>
                </div>
            </div>
            
            <input type="text" class="search-filter" id="searchBox" placeholder="üîç Rechercher..." oninput="debouncedFilterDeliveries()">
        </div>

        <div class="table-container">
            <h2 id="currentContainerTitle" style="margin-bottom: 15px; color: #2c3e50; font-size: 1.2em;">Conteneur en cours : Aucun</h2>
            <table id="deliveriesTable">
                <thead>
                    <tr>
                        <th class="col-checkbox"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th class="sortable" onclick="sortTable('conteneur')" style="width: 120px;">CONTENEUR ‚Üï</th>
                        <th class="sortable" onclick="sortTable('ref')" style="width: 100px;">REF ‚Üï</th>
                        <th class="sortable" onclick="sortTable('montant')" style="width: 100px;">MONTANT ‚Üï</th>
                        <th class="sortable" onclick="sortTable('expediteur')" style="width: 150px;">EXPEDITEUR ‚Üï</th>
                        <th class="sortable" onclick="sortTable('lieuLivraison')" style="width: 250px;">LIEU DE LIVRAISON ‚Üï</th>
                        <th class="sortable" onclick="sortTable('destinataire')" style="width: 180px;">DESTINATAIRE ‚Üï</th>
                        <th style="width: 250px;">DESCRIPTION</th>
                        <th style="width: 150px;">INFO</th>
                        <th class="sortable" onclick="sortTable('livreur')" style="width: 150px;">LIVREUR (DATE) ‚Üï</th>
                        <th style="width: 80px;">STATUT</th>
                        <th style="width: 150px;">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="deliveriesBody">
                    <tr>
                        <td colspan="12" class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <h3>Aucune livraison</h3>
                            <p>Importez un PDF/Excel ou ajoutez manuellement</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Ajout -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">‚ûï Nouvelle Livraison</h2>
            <form id="deliveryForm">
                <div class="form-grid">
                    <div class="form-group full-width" style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                        <label>Statut du Conteneur</label>
                        <select id="newContainerStatus">
                            <option value="PARIS">üá´üá∑ Stock Paris (Non charg√©)</option>
                            <option value="EN_COURS">üì¶ En cours (Arriv√©)</option>
                            <option value="A_VENIR">üö¢ √Ä venir (En transit)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>N¬∞ Conteneur</label>
                        <input type="text" id="conteneur" placeholder="Ex: CONT-123456">
                    </div>

                    <div class="form-group">
                        <label>R√©f√©rence *</label>
                        <input type="text" id="ref" required placeholder="Ex: BA-001-D44">
                    </div>
                    
                    <div class="form-group">
                        <label>Montant Restant</label>
                        <input type="text" id="montant" placeholder="Ex: 50000 CFA">
                    </div>
                    
                    <div class="form-group">
                        <label>Exp√©diteur *</label>
                        <input type="text" id="expediteur" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Commune *</label>
                        <select id="commune" required>
                            <option value="">-- S√©lectionnez --</option>
                            <option value="COCODY">COCODY</option>
                            <option value="YOPOUGON">YOPOUGON</option>
                            <option value="ABOBO">ABOBO</option>
                            <option value="ADJAME">ADJAM√â</option>
                            <option value="KOUMASSI">KOUMASSI</option>
                            <option value="MARCORY">MARCORY</option>
                            <option value="TREICHVILLE">TREICHVILLE</option>
                            <option value="ATTECOUBE">ATT√âCOUB√â</option>
                            <option value="PORT-BOUET">PORT-BOU√ãT</option>
                            <option value="BINGERVILLE">BINGERVILLE</option>
                            <option value="SONGON">SONGON</option>
                            <option value="ANYAMA">ANYAMA</option>
                            <option value="PLATEAU">PLATEAU</option>
                            <option value="AUTRE">AUTRE</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Lieu de Livraison *</label>
                        <input type="text" id="lieuLivraison" required list="sharedLocationsList" autocomplete="off">
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Destinataire & T√©l√©phone *</label>
                        <input type="text" id="destinataire" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Description</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">‚úÖ Ajouter</button>
                    <button type="button" class="btn btn-danger" onclick="closeAddModal()">‚ùå Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Aper√ßu Import -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">üìã Aper√ßu de l'import</h2>
            
            <div class="form-grid" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <div class="form-group full-width">
                    <label>Destination de l'import</label>
                    <select id="importContainerStatus" style="width: 100%;">
                        <option value="PARIS">üá´üá∑ Ajouter au Stock PARIS</option>
                        <option value="EN_COURS">üì¶ Ajouter aux Conteneurs EN COURS</option>
                        <option value="A_VENIR">üö¢ Ajouter aux Conteneurs √Ä VENIR</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>N¬∞ Conteneur (pour ce lot)</label>
                    <input type="text" id="importConteneur" placeholder="Appliquer √† tout l'import">
                </div>
                <div class="form-group">
                    <label>N¬∞ BL (pour ce lot)</label>
                    <input type="text" id="importBl" placeholder="Appliquer √† tout l'import">
                </div>
            </div>

            <p id="previewCount"></p>
            <div class="preview-table">
                <table>
                    <thead>
                        <tr>
                            <th>REF</th>
                            <th>EXPEDITEUR</th>
                            <th>COMMUNE</th>
                            <th>LIEU</th>
                            <th>INFO</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmImport()">‚úÖ Confirmer Import</button>
                <button class="btn btn-danger" onclick="closePreviewModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Programmation -->
    <div id="programModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">üìÖ Cr√©er un Programme de Livraison</h2>
            <p style="margin-bottom: 20px;">Assigner les <strong id="selectedCount">0</strong> colis s√©lectionn√©s √† :</p>
            
            <div class="form-grid">
                <div class="form-group full-width" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <label>‚ûï Ajouter √† un programme existant</label>
                    <select id="existingProgramSelect" onchange="fillProgramFields()">
                        <option value="">-- Nouveau Programme --</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Livreur / Chauffeur</label>
                    <input type="text" id="progLivreur" placeholder="Nom du livreur">
                </div>
                <div class="form-group full-width">
                    <label>Date de Livraison Pr√©vue</label>
                    <input type="date" id="progDate">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmProgram()">üíæ Enregistrer le Programme</button>
                <button class="btn btn-danger" onclick="closeProgramModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Attribution Conteneur -->
    <div id="assignContainerModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">üì¶ Attribuer un Conteneur</h2>
            <p style="margin-bottom: 20px;">Attribuer le conteneur suivant aux <strong id="assignSelectedCount">0</strong> colis s√©lectionn√©s :</p>
            
            <div class="form-group full-width">
                <label>Nouvelle Position (Optionnel)</label>
                <select id="assignContainerStatus">
                    <option value="">-- Ne pas changer la position --</option>
                    <option value="PARIS">üá´üá∑ Stock Paris</option>
                    <option value="A_VENIR">üö¢ En Transit (√Ä Venir)</option>
                    <option value="EN_COURS">üì¶ Arriv√© (En Cours)</option>
                </select>
            </div>
            
            <div class="form-group full-width">
                <label>N¬∞ Conteneur</label>
                <input type="text" id="assignConteneurInput" placeholder="Ex: CONT-123456">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmAssignContainer()">üíæ Enregistrer</button>
                <button class="btn btn-danger" onclick="closeAssignContainerModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal D√©tails Programme -->
    <div id="programDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 95%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="modal-header" style="margin-bottom: 0;">üìã Feuille de route</h2>
                <div style="display: flex; gap: 10px;">
                    <button id="btnOpenMap" class="btn btn-warning btn-small">üó∫Ô∏è Voir l'itin√©raire</button>
                    <button id="btnExportPdf" class="btn btn-success btn-small">üìÑ Exporter PDF</button>
                    <button class="btn btn-danger btn-small" onclick="closeProgramDetailsModal()">Fermer</button>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>Livreur :</strong> <span id="detailLivreur"></span></p>
                <p><strong>Date :</strong> <span id="detailDate"></span></p>
            </div>

            <div class="preview-table">
                <table id="programDetailsTable">
                    <!-- Rempli par JS -->
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Archives -->
    <div id="archivesModal" class="modal">
        <div class="modal-content" style="max-width: 95%; height: 90vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="modal-header" style="margin-bottom: 0;">üóÑÔ∏è Archives des Livraisons</h2>
                <button class="btn btn-danger btn-small" onclick="closeArchivesModal()">Fermer</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="archiveSearch" class="search-filter" placeholder="üîç Rechercher dans les archives..." oninput="searchArchives()">
            </div>

            <div class="preview-table" style="max-height: calc(90vh - 150px);">
                <table id="archivesTable">
                    <thead>
                        <tr>
                            <th>DATE ARCHIVAGE</th>
                            <th>REF</th>
                            <th>CONTENEUR</th>
                            <th>DESTINATAIRE</th>
                            <th>LIVREUR</th>
                            <th>DATE LIVRAISON</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="archivesBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Liste partag√©e pour l'auto-compl√©tion des lieux -->
    <datalist id="sharedLocationsList"></datalist>

    <script src="../livraison.js"></script>
</body>
</html>