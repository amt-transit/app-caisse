<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1000">
    <title>Tableau de Bord - Caisse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body style="display:none">
    <header class="app-header">
        <img src="LOGOAMT.png" alt="Logo" class="app-logo">
        <h1>Tableau de Bord</h1> <button id="logoutBtn" style="position: absolute; right: 20px; padding: 8px 15px; cursor: pointer;">D√©connexion</button>
    </header>

    <nav class="navigation">
        <a href="index.html">Saisie</a>
        <a href="dashboard.html" id="nav-dashboard" class="active">Tableau de Bord</a>
        <a href="history.html">Historique</a>
        <a href="expenses.html" id="nav-expenses">D√©penses</a>
        <a href="other-income.html" id="nav-other-income">Autres Entr√©es</a>
        <a href="bank.html" id="nav-bank">Banque</a>
        <a href="arrivages.html" id="nav-arrivages">Arrivages</a>
        <a href="magasinage.html" id="nav-magasinage">Magasinage</a>
        <a href="clients.html" id="nav-clients">Clients</a>
        <a href="admin-panel.html" id="nav-admin" style="background-color: #6f42c1; color: white;">ADMIN</a>
    </nav>

    <div class="dashboard-container">
        <div id="grandTotals" class="totals-container">
            <div class="total-card">
                <h3>Entr√©es Conteneur (Abidjan)</h3> 
                <p id="grandTotalPrix">0 CFA</p>
            </div>
            <div class="total-card">
                <h3>+ Autres Entr√©es</h3>
                <p id="grandTotalOtherIncome">0 CFA</p>
            </div>
            <div class="total-card">
                <h3 class="text-red">- D√©penses Totales</h3>
                <p id="grandTotalDepenses" class="text-red">0 CFA</p>
            </div>
            <div class="total-card">
                <h3>= B√âN√âFICE TOTAL</h3>
                <p id="grandTotalBenefice">0 CFA</p>
            </div>
            <div class="total-card">
                <h3>Total Ventes Per√ßues (A)</h3>
                <p id="grandTotalPercu">0 CFA</p>
                <span id="grandTotalParisHidden" class="text-blue-sub">Dont Paris: 0 CFA</span>
            </div>
            <div class="total-card">
                <h3>+ Retraits Banque</h3>
                <p id="grandTotalRetraits">0 CFA</p>
            </div>
            <div class="total-card">
                <h3>- D√©p√¥ts Banque</h3>
                <p id="grandTotalDepots">0 CFA</p>
            </div>
            <div class="total-card" style="border: 2px solid #6f42c1;">
                <h3 style="color: #6f42c1;">Ch√®ques en Coffre (√Ä d√©poser)</h3>
                <p id="grandTotalCheques" style="color: #6f42c1;">0 CFA</p>
            </div>
             <div class="total-card">
                <h3>= TOTAL CAISSE (Tr√©sorerie)</h3>
                <p id="grandTotalCaisse">0 CFA</p>
            </div>
            <div class="total-card">
                <h3>Op√©rations Totales</h3>
                <p id="grandTotalCount">0</p>
            </div>
            <div class="total-card">
                <h3 class="text-orange">Dettes Clients (Reste Total)</h3>
                <p id="grandTotalReste" class="text-orange">0 CFA</p>
            </div>
            <div class="filter-container" style="flex-grow: 2;">
                <h3>Filtrer par P√©riode</h3>
                <div class="filter-fields">
                    <label for="startDate">Du :</label> <input type="date" id="startDate">
                    <label for="endDate">Au :</label> <input type="date" id="endDate">
                    <button id="clearFilterBtn">R√©initialiser</button>
                </div>
            </div>
        </div> 
        
        <div class="sub-nav">
            <a href="#panel-conteneurs" class="active">Par Conteneur</a>
            <a href="#panel-clients">Top 100 Clients</a>
            <a href="#panel-agents">Par Agent</a>
            <a href="#panel-ventes">Ventes (par Mois)</a>
            <a href="#panel-depenses">D√©penses (Mensuelles)</a>
            <a href="#panel-banque">Mouvements Banque</a>
        </div>

        <div id="panel-conteneurs" class="tab-panel active">
            <h2 style="margin-top: 30px;">R√©capitulatif par Conteneur</h2>
            <table id="containerSummaryTable">
                <thead>
                    <tr>
                        <th>Conteneur</th><th>Chiffre d'Affaires (CA)</th><th>Total Paris</th><th>Total Abidjan</th>
                        <th>Total Per√ßu (P+A)</th><th>Total Reste</th><th>Total D√©penses</th><th>B√âN√âFICE Conteneur</th>
                    </tr>
                </thead>
                <tbody id="containerSummaryTableBody"></tbody>
            </table>
        </div>

        <div id="panel-clients" class="tab-panel">
            <h2 style="margin-top: 30px;">Top 100 Clients</h2>
            <table id="topClientsTable">
                <thead><tr><th>Rang</th><th>Client (Nom)</th><th>Destinataire</th><th>Nb. Op√©rations</th><th>Chiffre d'Affaires</th></tr></thead>
                <tbody id="topClientsTableBody"></tbody>
            </table>
        </div>

        <div id="panel-agents" class="tab-panel">
            <h2 style="margin-top: 30px;">R√©capitulatif par Agent</h2>
            <table id="agentSummaryTable">
                <thead><tr><th>Agent</th><th>Nombre d'Op√©rations</th><th>Chiffre d'Affaires</th></tr></thead>
                <tbody id="agentSummaryTableBody"></tbody>
            </table>
        </div>

        <div id="panel-ventes" class="tab-panel">
            <h2>R√©capitulatif par Mois (Ventes)</h2>
            <table id="summaryTable">
                <thead><tr><th>Mois</th><th>Nombre d'Op√©rations</th><th>Total des Prix</th></tr></thead>
                <tbody id="summaryTableBody"></tbody>
            </table>
        </div>

        <div id="panel-depenses" class="tab-panel">
            <h2 style="margin-top: 30px;">R√©capitulatif des D√©penses Mensuelles</h2>
            <table id="monthlyExpensesTable">
                <thead><tr><th>Date</th><th>Description</th><th>Montant</th></tr></thead>
                <tbody id="monthlyExpensesTableBody"></tbody>
            </table>
        </div>

        <div id="panel-banque" class="tab-panel">
            <h2 style="margin-top: 30px;">R√©capitulatif des Mouvements de Banque</h2>
            <table id="bankMovementsTable">
                <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Montant</th></tr></thead>
                <tbody id="bankMovementsTableBody"></tbody>
            </table>
        </div>

    </div>

    <!-- SECTION ANALYSES STRAT√âGIQUES (Structure d√©plac√©e du JS vers HTML) -->
    <div id="analyticsContainer" class="dashboard-container" style="margin-top: 20px;">
        <h2 style="margin-top:0;">üìä Analyses Strat√©giques</h2>
        <div class="charts-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <!-- Balance √Çg√©e -->
            <div class="chart-card">
                <h3>‚è≥ Balance √Çg√©e (Dettes)</h3>
                <table class="table">
                    <thead><tr><th>Anciennet√©</th><th>Reste √† Payer</th></tr></thead>
                    <tbody id="agedBalanceBody"></tbody>
                </table>
            </div>
            
            <!-- Performance Logistique -->
            <div class="chart-card">
                <h3>‚úàÔ∏è Performance Logistique</h3>
                <div style="text-align:center; padding: 20px;">
                    <div style="font-size: 12px; color: #64748b;">D√©lai Moyen (Paris -> Abidjan)</div>
                    <div id="avgLeadTime" style="font-size: 32px; font-weight: bold; color: #4f46e5;">-</div>
                    <div style="font-size: 11px; color: #64748b; margin-top:5px;">Bas√© sur les dates r√©elles</div>
                </div>
            </div>

            <!-- Clients Dormants -->
            <div class="chart-card" style="grid-column: span 2;">
                <h3>üí§ Clients √† Relancer (Inactifs > 3 mois)</h3>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table class="table">
                        <thead><tr><th>Client</th><th>Dernier Envoi</th><th>CA Perdu Potentiel</th></tr></thead>
                        <tbody id="dormantClientsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="containerDetailsModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 id="modalContainerTitle">D√©tails du Conteneur</h2>
                <span class="close-modal" id="closeContainerModal">&times;</span>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="containerDetailsTable"> 
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Destinataire</th>
                            <th>REF</th>
                            <th>Prix</th>
                            <th>Pay√© ABJ</th>
                            <th>Pay√© PAR</th>
                            <th>Reste</th>
                        </tr>
                    </thead>
                    <tbody id="containerDetailsTableBody">
                        </tbody>
                    <tfoot>
                        <tr style="background-color: #e9ecef; font-weight: bold;">
                            <th colspan="3" style="text-align:right">TOTAUX</th>
                            <th id="modalTotalPrix">0</th>
                            <th id="modalTotalPayeAbj">0</th>
                            <th id="modalTotalPayePar">0</th>
                            <th id="modalTotalReste">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA255n3XWDRKaYZ9kwOYkfovf5lRexoCA4",
            authDomain: "caisse-amt-perso.firebaseapp.com",
            projectId: "caisse-amt-perso",
            storageBucket: "caisse-amt-perso.firebasestorage.app",
            messagingSenderId: "682789156997",
            appId: "1:682789156997:web:9ce3303120851d37be91ec"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm("Voulez-vous vous d√©connecter ?")) firebase.auth().signOut();
        });
        
    </script>
    <script src="auth-guard.js"></script>
    <script src="dashboard.js"></script>
</body>
</html>
