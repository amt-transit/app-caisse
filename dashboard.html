<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1000">
    <title>Tableau de Bord - Caisse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body style="display:none">
    <header class="app-header">
        <img src="LOGOAMT.png" alt="Logo" class="app-logo">
        <h1>Tableau de Bord</h1> <button id="logoutBtn" style="position: absolute; right: 20px; padding: 8px 15px; cursor: pointer;">D√©connexion</button>
    </header>

    <nav class="navigation">
        <a href="index.html">Saisie</a>
        <a href="confirmation.html" id="nav-confirmation">Confirmation</a>
        <a href="dashboard.html" id="nav-dashboard" class="active">Tableau de Bord</a>
        <a href="history.html">Historique</a>
        <a href="expenses.html" id="nav-expenses">D√©penses</a>
        <a href="other-income.html" id="nav-other-income">Autres Entr√©es</a>
        <a href="bank.html" id="nav-bank">Banque</a>
        <a href="arrivages.html" id="nav-arrivages">Arrivages</a>
        <a href="magasinage.html" id="nav-magasinage">Magasinage</a>
        <a href="clients.html" id="nav-clients">Clients</a>
        <a href="salaire.html" id="nav-salaire">Salaire</a>
        <a href="admin-panel.html" id="nav-admin" style="background-color: #6f42c1; color: white;">ADMIN</a>
    </nav>

    <div class="dashboard-container">
        <div id="grandTotals" class="totals-container">
            <div class="total-card colored-card" id="card-percu">
                <h3>Total Ventes Per√ßues (A)</h3>
                <p id="grandTotalPercu">0 CFA</p>
                <span id="grandTotalParisHidden">Dont Paris: 0 CFA</span>
            </div>
            <div class="total-card colored-card" id="card-other">
                <h3>+ Autres Entr√©es</h3>
                <p id="grandTotalOtherIncome">0 CFA</p>
            </div>
            <div class="total-card colored-card" id="card-depenses">
                <h3>- D√©penses Totales</h3>
                <p id="grandTotalDepenses">0 CFA</p>
            </div>
            <div class="total-card" id="card-benefice">
                <h3>= B√âN√âFICE TOTAL</h3>
                <p id="grandTotalBenefice">0 CFA</p>
            </div>
            <div class="total-card colored-card" id="card-caisse-especes" style="background-color: #0ea5e9;">
                <h3>Solde Caisse (Esp√®ces + MM)</h3>
                <p id="grandTotalCaisse">0 CFA</p>
            </div>
            <div class="total-card colored-card" id="card-retraits">
                <h3>+ Retraits Banque</h3>
                <p id="grandTotalRetraits">0 CFA</p>
            </div>
            <div class="total-card colored-card" id="card-depots">
                <h3>- D√©p√¥ts Banque</h3>
                <p id="grandTotalDepots">0 CFA</p>
            </div>
            <div class="total-card colored-card" id="card-cheques">
                <h3>Ch√®ques en Coffre (√Ä d√©poser)</h3>
                <p id="grandTotalCheques">0 CFA</p>
            </div>
            <div class="total-card colored-card" id="card-virements" style="background-color: #8b5cf6;">
                <h3>Total Virements Re√ßus</h3>
                <p id="grandTotalVirements">0 CFA</p>
            </div>
            <div class="total-card">
                <h3>Op√©rations Totales</h3>
                <p id="grandTotalCount">0</p>
            </div>
            <div class="total-card colored-card" id="card-reste">
                <h3>Dettes Clients (Reste Total)</h3>
                <p id="grandTotalReste">0 CFA</p>
            </div>
            <div class="filter-container" style="flex-grow: 2;">
                <h3>Filtrer par P√©riode</h3>
                <div class="filter-fields">
                    <label for="startDate">Du :</label> <input type="date" id="startDate">
                    <label for="endDate">Au :</label> <input type="date" id="endDate">
                    <button id="clearFilterBtn">R√©initialiser</button>
                </div>
            </div>
        </div> 
        
        <div class="sub-nav">
            <a href="#panel-conteneurs" class="active">Par Conteneur</a>
            <a href="#panel-clients">Top 100 Clients</a>
            <a href="#panel-agents">Par Agent</a>
            <a href="#panel-ventes">Ventes (par Mois)</a>
            <a href="#panel-depenses">D√©penses (Mensuelles)</a>
            <a href="#panel-banque">Mouvements Banque</a>
            <a href="#panel-impayes" style="color: #dc3545;">‚ö†Ô∏è Impay√©s</a>
            <a href="#panel-adjustments">Ajustements</a>
        </div>

        <div id="panel-conteneurs" class="tab-panel active">
            <h2 style="margin-top: 30px;">R√©capitulatif par Conteneur</h2>
            <table id="containerSummaryTable">
                <thead>
                    <tr>
                        <th>Conteneur</th><th>Op. Totales</th><th>Non Pay√©s</th><th>Chiffre d'Affaires (CA)</th><th>Total Paris</th><th>Total Abidjan</th>
                        <th>Total Per√ßu (P+A)</th><th>Total Reste</th><th>Total D√©penses</th><th>B√âN√âFICE Conteneur</th>
                    </tr>
                </thead>
                <tbody id="containerSummaryTableBody"></tbody>
            </table>
        </div>

        <div id="panel-clients" class="tab-panel">
            <h2 style="margin-top: 30px;">Top 100 Clients</h2>
            <table id="topClientsTable">
                <thead><tr><th>Rang</th><th>Client (Nom)</th><th>Destinataire</th><th>Nb. Op√©rations</th><th>Chiffre d'Affaires</th></tr></thead>
                <tbody id="topClientsTableBody"></tbody>
            </table>
        </div>

        <div id="panel-agents" class="tab-panel">
            <h2 style="margin-top: 30px;">R√©capitulatif par Agent</h2>
            <table id="agentSummaryTable">
                <thead><tr><th>Agent</th><th>Nombre d'Op√©rations</th><th>Chiffre d'Affaires</th></tr></thead>
                <tbody id="agentSummaryTableBody"></tbody>
            </table>
        </div>

        <div id="panel-ventes" class="tab-panel">
            <h2>R√©capitulatif par Mois (Ventes)</h2>
            <table id="summaryTable">
                <thead><tr><th>Mois</th><th>Nombre d'Op√©rations</th><th>Total des Prix</th></tr></thead>
                <tbody id="summaryTableBody"></tbody>
            </table>
        </div>

        <div id="panel-depenses" class="tab-panel">
            <h2 style="margin-top: 30px;">R√©capitulatif des D√©penses Mensuelles</h2>
            <table id="monthlyExpensesTable">
                <thead><tr><th>Date</th><th>Description</th><th>Montant</th></tr></thead>
                <tbody id="monthlyExpensesTableBody"></tbody>
            </table>
        </div>

        <div id="panel-banque" class="tab-panel">
            <h2 style="margin-top: 30px;">R√©capitulatif des Mouvements de Banque</h2>
            <table id="bankMovementsTable">
                <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Montant</th></tr></thead>
                <tbody id="bankMovementsTableBody"></tbody>
            </table>
        </div>

        <div id="panel-impayes" class="tab-panel">
            <h2 style="margin-top: 30px; color: #dc3545;">Liste des Colis Impay√©s (Dettes)</h2>
            <table id="unpaidTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Conteneur</th>
                        <th>R√©f√©rence</th>
                        <th>Client</th>
                        <th>Prix Total</th>
                        <th>D√©j√† Pay√©</th>
                        <th>Reste √† Payer</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="unpaidTableBody"></tbody>
            </table>
        </div>

        <div id="panel-adjustments" class="tab-panel">
            <h2 style="margin-top: 30px;">Liste des R√©ductions & Augmentations</h2>
            <table id="adjustmentsTable">
                <thead>
                    <tr>
                        <th>Date</th><th>Client</th><th>R√©f√©rence</th><th>Type</th><th>Montant</th>
                    </tr>
                </thead>
                <tbody id="adjustmentsTableBody"></tbody>
            </table>
        </div>

    </div>

    <!-- NOUVELLE SECTION GRAPHIQUES -->
    <div class="dashboard-container" style="margin-top: 20px;">
        <h2 style="margin-top:0;">üìà √âvolution & Statistiques</h2>
        <div class="charts-grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
            <div class="chart-card">
                <h3>D√©penses : Mensuelles vs Conteneurs</h3>
                <canvas id="expenseEvolutionChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Activit√© Conteneurs (Arriv√©es & CA)</h3>
                <canvas id="containerEvolutionChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>R√©partition des Paiements</h3>
                <canvas id="paymentModeChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Top 10 Conteneurs (Rentabilit√©)</h3>
                <canvas id="topContainerProfitChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Ratio Dettes vs Encaiss√©</h3>
                <canvas id="debtVsCollectedChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Performance par Agent</h3>
                <canvas id="agentPerformanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- SECTION ANALYSES STRAT√âGIQUES (Structure d√©plac√©e du JS vers HTML) -->
    <div id="analyticsContainer" class="dashboard-container" style="margin-top: 20px;">
        <h2 style="margin-top:0;">üìä Analyses Strat√©giques</h2>
        <div class="charts-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <!-- Balance √Çg√©e -->
            <div class="chart-card">
                <h3>‚è≥ Balance √Çg√©e (Dettes)</h3>
                <table class="table">
                    <thead><tr><th>Anciennet√©</th><th>Reste √† Payer</th></tr></thead>
                    <tbody id="agedBalanceBody"></tbody>
                </table>
            </div>
            
            <!-- Performance Logistique -->
            <div class="chart-card">
                <h3>‚úàÔ∏è Performance Logistique</h3>
                <div style="text-align:center; padding: 20px;">
                    <div style="font-size: 12px; color: #64748b;">D√©lai Moyen (Paris -> Abidjan)</div>
                    <div id="avgLeadTime" style="font-size: 32px; font-weight: bold; color: #4f46e5;">-</div>
                    <div style="font-size: 11px; color: #64748b; margin-top:5px;">Bas√© sur les dates r√©elles</div>
                </div>
            </div>

            <!-- Clients Dormants -->
            <div class="chart-card" style="grid-column: span 2;">
                <h3>üí§ Clients √† Relancer (Inactifs > 3 mois)</h3>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table class="table">
                        <thead><tr><th>Client</th><th>Dernier Envoi</th><th>CA Perdu Potentiel</th></tr></thead>
                        <tbody id="dormantClientsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="containerDetailsModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 id="modalContainerTitle">D√©tails du Conteneur</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button id="downloadContainerPdfBtn" style="background-color: #d32f2f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 5px;">üìÑ PDF</button>
                    <span class="close-modal" id="closeContainerModal">&times;</span>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="containerDetailsTable"> 
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Destinataire</th>
                            <th>REF</th>
                            <th>Prix</th>
                            <th>Pay√© ABJ</th>
                            <th>Pay√© PAR</th>
                            <th>Reste</th>
                        </tr>
                    </thead>
                    <tbody id="containerDetailsTableBody">
                        </tbody>
                    <tfoot>
                        <tr style="background-color: #e9ecef; font-weight: bold;">
                            <th colspan="3" style="text-align:right">TOTAUX</th>
                            <th id="modalTotalPrix">0</th>
                            <th id="modalTotalPayeAbj">0</th>
                            <th id="modalTotalPayePar">0</th>
                            <th id="modalTotalReste">0</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="firebase-init.js"></script>
    <script src="auth-guard.js"></script>
    <script src="dashboard.js"></script>
</body>
</html>
